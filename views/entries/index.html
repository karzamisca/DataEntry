<!-- views/entries/index.html -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
      Hệ thống Theo Dõi Chi Phí Dự Án / Project Expenses Tracking System
    </title>
    <style>
      /* Base styles for all screen sizes */
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        padding: 0;
        box-sizing: border-box;
        max-width: 100vw;
        overflow-x: hidden;
      }

      h1,
      h2 {
        color: #333;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
        font-size: 1rem;
      }

      table,
      th,
      td {
        border: 1px solid black;
      }

      th,
      td {
        padding: 8px;
        text-align: left;
      }

      form {
        display: flex;
        justify-content: space-between;
        flex-wrap: wrap;
        width: 100%;
      }

      .form-group {
        margin-bottom: 10px;
        width: 15%; /* Use relative width */
      }

      form input,
      form button {
        padding: 5px;
        margin-left: 5px;
        width: 100%; /* Full width for inputs */
      }

      /* Media queries for responsiveness */

      /* Small devices (mobile) */
      @media only screen and (max-width: 600px) {
        h1,
        h2 {
          font-size: 1.2rem;
        }

        table {
          font-size: 0.8rem; /* Smaller font size for small screens */
        }

        .form-group {
          width: 48%; /* Stack the inputs side by side on smaller screens */
        }

        form input,
        form button {
          padding: 10px;
          margin-left: 0;
        }
      }

      /* Medium devices (tablets) */
      @media only screen and (min-width: 600px) and (max-width: 1024px) {
        h1,
        h2 {
          font-size: 1.5rem;
        }

        table {
          font-size: 0.9rem;
        }

        .form-group {
          width: 30%;
        }

        form input,
        form button {
          padding: 8px;
        }
      }

      /* Large devices (desktops) */
      @media only screen and (min-width: 1024px) {
        h1,
        h2 {
          font-size: 2rem;
        }

        table {
          font-size: 1rem;
        }

        .form-group {
          width: 15%;
        }

        form input,
        form button {
          padding: 5px;
        }
      }
    </style>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
    />
  </head>
  <body>
    <h1>Hệ thống Theo Dõi Chi Phí Dự Án / Project Expenses Tracking System</h1>

    <!-- Export Button -->
    <button id="exportButton">Xuất ra Excel / Export to Excel</button>

    <!-- Search fields for each column -->
    <h2>Lọc/Filter</h2>
    <div>
      <label for="searchTag">Tem/Tag:</label>
      <input type="text" id="searchTag" placeholder="Search by tag" />

      <label for="searchName">Tên dự án/Project Name:</label>
      <input type="text" id="searchName" placeholder="Search by name" />

      <label for="searchDescription">Mô tả/Description:</label>
      <input
        type="text"
        id="searchDescription"
        placeholder="Search by description"
      />

      <label for="searchUnit">Đơn vị/Unit:</label>
      <input type="text" id="searchUnit" placeholder="Search by unit" />

      <label for="searchAmount">Số lượng/Amount:</label>
      <input type="number" id="searchAmount" placeholder="Search by amount" />

      <label for="searchUnitPrice">Đơn giá/Unit Price:</label>
      <input
        type="number"
        id="searchUnitPrice"
        placeholder="Search by unit price"
      />

      <label for="searchTotalPrice">Thành tiền /Total Price:</label>
      <input
        type="number"
        id="searchTotalPrice"
        placeholder="Search by total price"
      />

      <label for="searchVAT">Thuế giá trị gia tăng/VAT (%):</label>
      <input type="number" id="searchVAT" placeholder="Search by VAT" />

      <label for="searchVATValue">Giá trị VAT/VAT Value:</label>
      <input
        type="number"
        id="searchVATValue"
        placeholder="Search by VAT Value"
      />

      <label for="searchTotalPriceAfterVAT"
        >Tổng tiền sau VAT/Total Price After VAT:</label
      >
      <input
        type="number"
        id="searchTotalPriceAfterVAT"
        placeholder="Search by total after VAT"
      />

      <label for="searchDeliveryDate">Ngày giao hàng/Delivery Date:</label>
      <input type="date" id="searchDeliveryDate" />

      <label for="searchNote">Ghi chú/Note:</label>
      <input type="text" id="searchNote" />

      <label for="searchEntryDate">Ngày nhập liệu/Entry Date:</label>
      <input type="date" id="searchEntryDate" />

      <label for="searchSubmitter">Người nhập/Submitter:</label>
      <input type="text" id="searchSubmitter" />

      <label for="searchApprovedPayment"
        >Xác nhận đã thanh toán/Approved Payment:</label
      >
      <input type="text" id="searchApprovedPayment" />

      <label for="searchConfirmedReceived"
        >Xác nhận đã nhận hàng/Confirmed Received:</label
      >
      <input type="text" id="searchConfirmedReceived" />
    </div>

    <h2>Bảng dữ liệu/Entries Table</h2>
    <!-- Table for displaying entries -->
    <table id="entriesTable">
      <thead>
        <tr>
          <th onclick="sortTable(0)">Tem/Tag</th>
          <th onclick="sortTable(1)">Tên dự án/Project name</th>
          <th onclick="sortTable(2)">Mô tả/Description</th>
          <th onclick="sortTable(3)">Đơn vị/Unit</th>
          <th onclick="sortTable(4)">Số lượng/Amount</th>
          <th onclick="sortTable(5)">Đơn giá/Unit Price</th>
          <th onclick="sortTable(6)">Thành tiền /Total Price</th>
          <th onclick="sortTable(7)">Thuế giá trị gia tăng/VAT (%)</th>
          <th onclick="sortTable(8)">Giá trị VAT/VAT Value</th>
          <th onclick="sortTable(9)">
            Thành tiền sau VAT/Total Price After VAT
          </th>
          <th onclick="sortTable(10)">Ngày giao hàng/Delivery Date</th>
          <th onclick="sortTable(11)">Ghi chú/Note</th>
          <th onclick="sortTable(12)">Ngày nhập liệu/Entry Date</th>
          <th onclick="sortTable(13)">Người nhập liệu/Submitter</th>
          <th onclick="sortTable(14)">
            Xác nhận đã thanh toán/Approved Payment
          </th>
          <th onclick="sortTable(15)">
            Xác nhận đã nhận hàng/Confirmed Received
          </th>
          <th>Hành động/Actions</th>
        </tr>
      </thead>
      <tbody>
        <!-- Rows will be inserted dynamically by JavaScript -->
      </tbody>
    </table>

    <h2>Nhập liệu mới/New Entry</h2>
    <!-- Form for adding a new entry -->
    <form id="entryForm" action="/entryNew" method="POST">
      <div class="form-group">
        <label for="name">Tên/Name:</label>
        <input type="text" id="name" name="name" required />
      </div>

      <div class="form-group">
        <label for="description">Mô tả/Description:</label>
        <input type="text" id="description" name="description" required />
      </div>

      <div class="form-group">
        <label for="unit">Đơn vị/Unit:</label>
        <input type="text" id="unit" name="unit" required />
      </div>

      <div class="form-group">
        <label for="amount">Số lượng/Amount:</label>
        <input type="number" id="amount" name="amount" required />
      </div>

      <div class="form-group">
        <label for="unitPrice">Đơn giá/Unit Price:</label>
        <input
          type="number"
          step="0.01"
          id="unitPrice"
          name="unitPrice"
          required
        />
      </div>

      <div class="form-group">
        <label for="vat">Thuế giá trị gia tăng/VAT (%):</label>
        <input type="number" step="0.01" id="vat" name="vat" required />
      </div>

      <div class="form-group">
        <label for="deliveryDate">Ngày giao hàng/Delivery Date:</label>
        <input type="date" id="deliveryDate" name="deliveryDate" required />
      </div>

      <div class="form-group">
        <label for="note">Ghi chú/Note:</label>
        <input type="text" id="note" name="note" required />
      </div>

      <button type="submit">Nộp/Submit</button>
    </form>

    <h2>Theo dõi/Trackers</h2>
    <div>
      <p>
        <strong>Chưa thanh toán/Unpaid:</strong>
        <span id="unpaidTracker">0</span>
      </p>
      <p>
        <strong>Đã thanh toán/Paid:</strong> <span id="paidTracker">0</span>
      </p>
    </div>

    <h2>Chỉnh sửa dữ liệu/Update Entry</h2>
    <form id="updateForm" action="/entryUpdate" method="POST">
      <div class="form-group">
        <label for="tag">Chọn tem/Choose tag:</label>
        <select id="tag" name="tag" required>
          <option value="" disabled selected>Select a tag</option>
        </select>
      </div>

      <div class="form-group">
        <label for="name">Tên dự án/Project Name:</label>
        <input type="text" id="name" name="name" />
      </div>

      <div class="form-group">
        <label for="description">Mô tả/Description:</label>
        <input type="text" id="description" name="description" />
      </div>

      <!-- Add other fields as needed -->
      <button type="submit">Update</button>
    </form>

    <h2>Nhập liệu từ Excel/Import Entries from Excel</h2>
    <!-- Form for importing Excel files -->
    <form
      id="importForm"
      action="/entryImport"
      method="POST"
      enctype="multipart/form-data"
    >
      <input type="file" name="excelFile" accept=".xlsx, .xls" required />
      <button type="submit">Nhập vào từ Excel/Import from Excel</button>
    </form>

    <a href="/main">Trở về trang chủ/Back to Main</a><br />
    <a href="/logout">Đăng xuất/Logout</a><br />

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <script>
      // Load Flatpickr for the Delivery Date and Entry Date inputs
      document.addEventListener("DOMContentLoaded", () => {
        flatpickr("#searchDeliveryDate", { dateFormat: "d-m-Y" });
        flatpickr("#searchEntryDate", { dateFormat: "d-m-Y" });
        flatpickr("#deliveryDate", {
          dateFormat: "d-m-Y",
          defaultDate: "today",
        });
      });

      document.addEventListener("DOMContentLoaded", async () => {
        const tagDropdown = document.getElementById("tag");

        try {
          // Fetch tags from the server
          const response = await fetch("/entryTags");
          const tags = await response.json();

          // Populate the dropdown
          tags.forEach((tag) => {
            const option = document.createElement("option");
            option.value = tag.tag;
            option.textContent = tag.tag;
            tagDropdown.appendChild(option);
          });
        } catch (err) {
          console.error("Error fetching tags:", err);
        }
      });

      // Sort table function
      function sortTable(columnIndex) {
        const table = document.getElementById("entriesTable");
        let rows,
          switching,
          i,
          x,
          y,
          shouldSwitch,
          dir,
          switchCount = 0;
        switching = true;
        dir = "asc"; // Set the sorting direction to ascending

        while (switching) {
          switching = false;
          rows = table.rows;
          for (i = 1; i < rows.length - 1; i++) {
            shouldSwitch = false;
            x = rows[i].getElementsByTagName("TD")[columnIndex];
            y = rows[i + 1].getElementsByTagName("TD")[columnIndex];

            if (dir === "asc") {
              if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
                shouldSwitch = true;
                break;
              }
            } else if (dir === "desc") {
              if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {
                shouldSwitch = true;
                break;
              }
            }
          }
          if (shouldSwitch) {
            rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
            switching = true;
            switchCount++;
          } else {
            if (switchCount === 0 && dir === "asc") {
              dir = "desc";
              switching = true;
            }
          }
        }
      }

      // Search function for each field
      function filterTable() {
        const filterTag = document
          .getElementById("searchTag")
          .value.toLowerCase();
        const filterName = document
          .getElementById("searchName")
          .value.toLowerCase();
        const filterDescription = document
          .getElementById("searchDescription")
          .value.toLowerCase();
        const filterUnit = document
          .getElementById("searchUnit")
          .value.toLowerCase();
        const filterAmount = document.getElementById("searchAmount").value;
        const filterUnitPrice =
          document.getElementById("searchUnitPrice").value;
        const filterTotalPrice =
          document.getElementById("searchTotalPrice").value;
        const filterVAT = document.getElementById("searchVAT").value;
        const filterVATValue = document.getElementById("searchVATValue").value;
        const filterTotalPriceAfterVAT = document.getElementById(
          "searchTotalPriceAfterVAT"
        ).value;
        const filterDeliveryDate =
          document.getElementById("searchDeliveryDate").value;
        const filterNote = document.getElementById("searchNote").value;
        const filterEntryDate =
          document.getElementById("searchEntryDate").value;
        const filterSubmitter =
          document.getElementById("searchSubmitter").value;
        const filterApprovedPayment = document.getElementById(
          "searchApprovedPayment"
        ).value;
        const filterConfirmedReceived = document.getElementById(
          "searchConfirmedReceived"
        ).value;

        const rows = document.querySelectorAll("#entriesTable tbody tr");

        rows.forEach((row) => {
          const tag = row.cells[0].textContent;
          const name = row.cells[1].textContent;
          const description = row.cells[2].textContent;
          const unit = row.cells[3].textContent;
          const amount = row.cells[4].textContent;
          const unitPrice = row.cells[5].textContent;
          const totalPrice = row.cells[6].textContent;
          const vat = row.cells[7].textContent;
          const vatValue = row.cells[8].textContent;
          const totalPriceAfterVAT = row.cells[9].textContent;
          const deliveryDate = row.cells[10].textContent;
          const note = row.cells[11].textContent;
          const entryDate = row.cells[12].textContent;
          const submitter = row.cells[13].textContent;
          const approvedPayment = row.cells[14].textContent;
          const confirmedReceived = row.cells[15].textContent;

          const matchesTag = !filterTag || tag.includes(filterTag);
          const matchesName = !filterName || name.includes(filterName);
          const matchesDescription =
            !filterDescription || description.includes(filterDescription);
          const matchesUnit = !filterUnit || unit.includes(filterUnit);
          const matchesAmount = !filterAmount || amount == filterAmount;
          const matchesUnitPrice =
            !filterUnitPrice || unitPrice == filterUnitPrice;
          const matchesTotalPrice =
            !filterTotalPrice || totalPrice == filterTotalPrice;
          const matchesVAT = !filterVAT || vat == filterVAT;
          const matchesVATValue = !filterVATValue || vatValue == filterVATValue;
          const matchesTotalPriceAfterVAT =
            !filterTotalPriceAfterVAT ||
            totalPriceAfterVAT == filterTotalPriceAfterVAT;
          const matchesDeliveryDate =
            !filterDeliveryDate || deliveryDate == filterDeliveryDate;
          const matchesNote = !filterNote || note.includes(filterNote);
          const matchesEntryDate =
            !filterEntryDate || entryDate.includes(filterEntryDate);
          const matchesSubmitter =
            !filterSubmitter || submitter.includes(filterSubmitter);
          const matchesApprovedPayment =
            !filterApprovedPayment ||
            approvedPayment.includes(filterApprovedPayment);
          const matchesConfirmedReceived =
            !filterConfirmedReceived ||
            confirmedReceived.includes(filterConfirmedReceived);

          row.style.display =
            matchesTag &&
            matchesName &&
            matchesDescription &&
            matchesUnit &&
            matchesAmount &&
            matchesUnitPrice &&
            matchesTotalPrice &&
            matchesVAT &&
            matchesVATValue &&
            matchesTotalPriceAfterVAT &&
            matchesDeliveryDate &&
            matchesNote &&
            matchesEntryDate &&
            matchesSubmitter &&
            matchesApprovedPayment &&
            matchesConfirmedReceived
              ? ""
              : "none";
        });
      }

      window.onload = async function () {
        const tableBody = document.querySelector("#entriesTable tbody");
        const exportButton = document.getElementById("exportButton");
        const unpaidTracker = document.getElementById("unpaidTracker");
        const paidTracker = document.getElementById("paidTracker");

        // Fetch entries from the backend
        const response = await fetch("/entryAll");
        const entries = await response.json();

        let totalUnpaid = 0;
        let totalPaid = 0;

        entries.forEach((entry) => {
          const row = document.createElement("tr");

          row.innerHTML = `
            <td>${entry.tag}</td>
            <td>${entry.name}</td>
            <td>${entry.description}</td>
            <td>${entry.unit}</td>
            <td>${entry.amount}</td>
            <td>${entry.unitPrice}</td>
            <td>${entry.totalPrice}</td>
            <td>${entry.vat}</td>
            <td>${entry.vatValue}</td>
            <td>${entry.totalPriceAfterVat}</td>
            <td>${entry.deliveryDate}</td>
            <td>${entry.note}</td>
            <td>${entry.entryDate}</td>
            <td>${entry.submittedBy.username} (${
            entry.submittedBy.department
          })</td>
            <td>
            ${
              entry.approvalPayment
                ? `${entry.approvedPaymentBy.username} (${entry.approvedPaymentBy.department}) vào ${entry.approvalPaymentDate}`
                : "Chưa xác nhận"
            }
            </td>
            <td>
            ${
              entry.approvalReceive
                ? `${entry.approvedReceiveBy.username} (${entry.approvedReceiveBy.department}) vào ${entry.approvalReceiveDate}`
                : "Chưa xác nhận"
            }
            </td>
            <td>
            ${
              entry.approvalPayment
                ? ""
                : `<button class="approve-payment-button" data-id="${entry._id}">Xác nhận trả tiền/Approve Payment</button>`
            }
            ${
              entry.approvalReceive
                ? ""
                : `<button class="approve-receive-button" data-id="${entry._id}">Xác nhận đã nhận hàng/Confirm Receipt</button>`
            }
            <button class="delete-button" data-id="${
              entry._id
            }">Xóa/Delete</button>
            </td>
      `;

          tableBody.appendChild(row);

          if (!entry.approvalPayment) {
            totalUnpaid += entry.totalPriceAfterVat;
          } else {
            totalPaid += entry.totalPriceAfterVat;
          }
        });

        unpaidTracker.textContent = totalUnpaid.toFixed(2);
        paidTracker.textContent = totalPaid.toFixed(2);

        document.querySelectorAll(".delete-button").forEach((button) => {
          button.addEventListener("click", async (event) => {
            const entryId = event.target.getAttribute("data-id");
            if (
              confirm(
                "Bạn có chắc chắn muốn xóa dữ liệu này không?/Are you sure you want to delete this entry?"
              )
            ) {
              const deleteResponse = await fetch(`/entryDelete/${entryId}`, {
                method: "DELETE",
              });

              if (deleteResponse.ok) {
                alert("Xóa dữ liệu thành công/Entry deleted successfully!");
                location.reload(); // Reload the page after deletion
              } else {
                const errorData = await deleteResponse.json();
                alert("Error deleting entry: " + errorData.error);
              }
            }
          });
        });

        document
          .querySelectorAll(".approve-payment-button")
          .forEach((button) => {
            button.addEventListener("click", async (event) => {
              const entryId = event.target.getAttribute("data-id");
              const approveResponse = await fetch(
                `/entryPaymentApprove/${entryId}`,
                {
                  method: "POST",
                }
              );

              if (approveResponse.ok) {
                alert("Entry approved successfully!");
                location.reload(); // Reload the page after approval
              } else {
                const errorData = await approveResponse.json();
                alert("Error approving entry: " + errorData.error);
              }
            });
          });

        document
          .querySelectorAll(".approve-receive-button")
          .forEach((button) => {
            button.addEventListener("click", async (event) => {
              const entryId = event.target.getAttribute("data-id");
              const approveResponse = await fetch(
                `/entryReceiveApprove/${entryId}`,
                {
                  method: "POST",
                }
              );

              if (approveResponse.ok) {
                alert("Entry approved successfully!");
                location.reload(); // Reload the page after approval
              } else {
                const errorData = await approveResponse.json();
                alert("Error approving entry: " + errorData.error);
              }
            });
          });

        // Add event listeners to each search field
        document
          .querySelectorAll(
            "#searchTag, #searchName, #searchDescription, #searchUnit, #searchAmount, #searchUnitPrice, #searchTotalPrice, #searchVAT, #searchVATValue, #searchTotalPriceAfterVAT, #searchDeliveryDate, #searchNote, #searchEntryDate, #searchSubmitter, #searchApprovedPayment, #searchConfirmedReceived"
          )
          .forEach((input) => input.addEventListener("input", filterTable));

        exportButton.addEventListener("click", () => {
          window.location.href = "/entryExport";
        });
      };
    </script>
  </body>
</html>
